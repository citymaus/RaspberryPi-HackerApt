<!DOCTYPE html>
<html>
<head>
    <title>DC Weather Data</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="api/darksky/weather.js"></script>
    <script src="js/api_key.js"></script>
	<link href="css/style.css" rel="stylesheet">
	<link href="css/weather-bar.css" rel="stylesheet">
	<link href="css/fontawesome-all.css" rel="stylesheet">
    <!--<link href="css/dripicons-style.css" rel="stylesheet" > -->
    <link href="css/dripicons-webfont.css" rel="stylesheet">
</head>
<body>
<p id="display"></p>
<script type="text/javascript">
    $(function() {
		// Set DARKSKY API key in: 	/html/api/api_keys.txt
		//	DARK SKY API: 1000 requests per day, 41 per hour.
		// 		Every 15 minutes: 96 requests/day
		// 		Every 5 minutes: 288 requests/day
		
		var coordinates = "38.9281,-77.0342";
		var darkSkyUrl_forecast = "https://api.darksky.net/forecast/";
		//var userStationFile = "wmata/_display_train_stations.txt";
		var refreshRate = 0;	// TODO
		
		var staticWeatherData = {};		
		var allWeatherAlerts = [];
		var allWeatherHourly = {};
		var allWeatherDaily = {};
		
		var displayObj = document.getElementById("display");
		
		
		var dateObj = new Date();
		var dateNow = dateObj.toLocaleDateString();
		var timeNow = dateObj.toLocaleTimeString();
		var dayOfWeek = dateObj.getDay();
		var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
		var today = days[dayOfWeek];
		var timezone = "";
		var offset = "";
		
		// File loading functions
		// ----------------------------------------------------------
		function loadJSON(callback) {
			var xobj = new XMLHttpRequest();
				xobj.overrideMimeType("application/json");
			// Synchronous ajax call (false)
			xobj.open('GET', 'api/darksky/static_dcexample.json', false);
			xobj.onreadystatechange = function () {
				  if (xobj.readyState == 4 && xobj.status == "200") {
					callback(xobj.responseText);
				  }
			};
			xobj.send(null);  			
		}		
		function setWeatherDataCallback(data) {
			staticWeatherData = JSON.parse(data);
		}	
	
		function saveWeatherInfoStatic(){
			var weatherHourly = staticWeatherData.hourly;
			var weatherDaily = staticWeatherData.daily;
			var weatherAlerts = staticWeatherData.alerts;
			
			allWeatherHourly = new WeatherHourlies(weatherHourly);
			allWeatherDaily = new WeatherDailies(weatherDaily);

			for (var i = 0; i < weatherAlerts.length; i++) {
				allWeatherAlerts.push(new WeatherAlert(weatherAlerts[i]));
			}
		}    
		function saveWeatherInfoAJAX(stopID) {
			var params = {
				"exclude": "minutely",
			};
			$.ajax({
				url: "https://api.darksky.net/forecast/" + apiKeyHelper.apiKey + "/" + coordinates + "?" + $.param(params),
				type: "GET",
				async: false,
			})
			.done(function(data) {
				var weatherData = data;
				var weatherHourly = weatherData.hourly;
				var weatherDaily = weatherData.daily;
				var weatherAlerts = weatherData.alerts;
				
				allWeatherHourly = new WeatherHourlies(weatherHourly);
				allWeatherDaily = new WeatherDailies(weatherDaily);

				if (weatherAlerts !== undefined) {
					for (var i = 0; i < weatherAlerts.length; i++) {
						allWeatherAlerts.push(new WeatherAlert(weatherAlerts[i]));
					}
				}
			})
			.fail(function(xhr, status, error) {
				displayObj.innerHTML += "<br>Error: " + error.message;
			});
			
		}  
		function displayWeatherInfo() {
			var weatherUtils = new WeatherUtils();
			var pageHTML = "<table class='outerTable forecast-table'>";
			
			// Alerts
			if (allWeatherAlerts.length > 0) {
				pageHTML += "<tr><td colspan='4' width='100%'>";
				pageHTML += "<table border=0 cellpadding=5 cellspacing=0>";
				if (allWeatherAlerts !== undefined || allWeatherAlerts.length > 0) {
					for (var a = 0; a < allWeatherAlerts.length; a++) {
						var currentAlert = allWeatherAlerts[a];
						pageHTML += "<tr><td>";
						pageHTML += currentAlert.title + " (" + currentAlert.regions.join(",") + ")<br>";
						pageHTML += "Severity: " + currentAlert.severity + "<br>"
						pageHTML += "Issued: " + currentAlert.getDate(currentAlert.time) + " " + currentAlert.getTime(currentAlert.time) + "<br>";
						pageHTML += "Expires: " + currentAlert.getDate(currentAlert.expires) + " " + currentAlert.getTime(currentAlert.expires) + "<br>";
						pageHTML += "<br>" + currentAlert.description + "<br>";
						pageHTML += "<a href='" + currentAlert.moreInfoUri + "'>MORE INFO</a>";
						pageHTML += "</td></tr>";
					}
				}
				pageHTML += "</table></td></tr>";
			}
			
			// Today
			// -------------------------------------------------------------
			var currentHour = allWeatherHourly.allHours[0];
			pageHTML += "<tr><td style='vertical-align:top;' rowspan='2' class='weather-panel " 
				+ weatherUtils.getDayBackgroundColor(currentHour.icon) + "'>";
			pageHTML += "<span class='weather-day weather-uppercase'>" + currentHour.getDay() + "</span> ";
			pageHTML += "<span class='weather-uppercase weather-date'>" + currentHour.getDate() + "</span><br>";
			pageHTML += currentHour.getTime() + "<br>";
			pageHTML += "<span class='weather-icon'><i class='icon diw-" + weatherUtils.getWeatherIcon(currentHour.icon);
			pageHTML += "' title='" + currentHour.icon + "'></i></span><br>";
			pageHTML += "<span class='forecast-hi'>" + Math.round(currentHour.temperature) + "&#0176;</span>";
			pageHTML += "&nbsp;";
			pageHTML += "<span class='forecast-summary'>" + currentHour.summary + "</span><br>";
			// EVERY THREE HOURS
			pageHTML += "<table border=1 cellpadding=10 cellspacing=0>";
			for (var h = 2; h < 9; h += 3) {	
				var currentForecast = allWeatherHourly.allHours[h];
				pageHTML += "<tr>";
				pageHTML += "<td>" + currentForecast.getTime() + "</td>";
				pageHTML += "<td><i class='weather-icon icon diw-" + weatherUtils.getWeatherIcon(currentForecast.icon);
				pageHTML += "' style='font-size:25pt;' title='" + currentForecast.icon + "'></i></td></tr>";
			}
			pageHTML += "</table>";
			
			var todayForecast = allWeatherDaily.allDays[0];
			pageHTML += "<span class='forecast-hi'>" + Math.round(todayForecast.temperatureHigh) + "&#0176;</span>" + " / ";
			pageHTML += Math.round(todayForecast.temperatureLow) + "&#0176;<br>";
			
			pageHTML += "<table border=1 cellpadding=10 cellspacing=0>";
			pageHTML += "<tr><td>";
			pageHTML += "<i class='icon diw-" + weatherUtils.getPrecipWeatherIcon(todayForecast.precipType, todayForecast.precipType);
			pageHTML += "' title='" + todayForecast.precipType + "'></i>";
			pageHTML += "</td><td>";
			pageHTML += Math.round(todayForecast.precipProbability) + "%";
			pageHTML += "</td></tr><tr>";			
			pageHTML += "<td><i class='icon diw-sun-low' title='sunrise'></i></td><td>";
			pageHTML += weatherUtils.getTime(todayForecast.sunriseTime) + "</td><tr>";
			pageHTML += "<td><i class='icon diw-sun-lower' title='sunset'></i></td><td>";
			pageHTML += weatherUtils.getTime(todayForecast.sunsetTime) + "</td></tr></table>";
			pageHTML += "</td>";
			
			// -------------------------------------------------------------			
			// Next six days
			// -------------------------------------------------------------			
			pageHTML += forecastRow(weatherUtils, allWeatherDaily, 1, 4);
			pageHTML += "</tr><tr>";
			pageHTML += forecastRow(weatherUtils, allWeatherDaily, 4, 7);
			pageHTML += "</tr></table>";
			// -------------------------------------------------------------
			return pageHTML;
		}
		
		function forecastRow(weatherUtils, allWeatherDaily, startDay, endDay) {	
			var rowHTML = "";
			for (var day = startDay; day < endDay; day++) {		
				var currentDay = allWeatherDaily.allDays[day];
				rowHTML += "<td class='forecast-next-seven weather-panel "
					+ weatherUtils.getDayBackgroundColor(currentDay.icon) + "'>";
				rowHTML += "<span class='weather-uppercase weather-day day-" + currentDay.getDay() + "'>" + currentDay.getDay() + "</span> ";
				rowHTML += "<span class='weather-uppercase weather-date'>" + currentDay.getDate() + "</span><br>";
				rowHTML += "<i class='weather-icon icon diw-" + weatherUtils.getWeatherIcon(currentDay.icon);
				rowHTML += "' title='" + currentDay.icon + "'></i><br>";
				
				// Vertical Bar Test
				// https://stackoverflow.com/questions/4245209/vertical-css-html5-progress-bar
				//https://stackoverflow.com/questions/8837050/allow-specific-tag-to-override-overflowhidden
				// Try Waterfall charts!
				//https://developers.google.com/chart/interactive/docs/gallery/candlestickchart
				// Trying to emulate:
				// https://blog.darksky.net/forecast-embeds/
				var tempHigh = Math.round(currentDay.temperatureHigh);
				var tempLow = Math.round(currentDay.temperatureLow);
				//var topTemp = 80;
				//var bottomTemp = 25;
				var topTemp = 60;
				var bottomTemp = 45;
				tempHigh = topTemp;
				tempLow = bottomTemp;
				//topTemp = tempHigh;
				//bottomTemp = tempLow+10;
				var totalTemp = (topTemp - bottomTemp)// + 10); // Add 10 for tiny differences
				//var topTempPosition = (100-topTemp+5);
				var topTempPosition = (100-tempHigh-15); // this is right at tempHigh = 80
				var bottomTempPosition = (tempLow-20); // this is right at tempHigh = 80
				rowHTML += "<div class='relative-wrap'>";
				rowHTML += 		"<div class='overflow-wrap'>";
				rowHTML += 			"<div class='ignore-overflow' style='top: " + topTempPosition + "%; left: 2px;'>" + tempHigh  + "&#0176;</div>";
				rowHTML += 			"<div class='respect-overflow' style='height: " + totalTemp + "%;bottom: " + tempLow + "%; z-index:300;'>";
				rowHTML += 				"<div></div>";
				rowHTML += 			"</div>";
				rowHTML += 			"<div class='ignore-overflow' style='bottom: " + bottomTempPosition + "%; left: 2px;'>" + tempLow  + "&#0176;</div>";
				rowHTML += 		"</div>";
				rowHTML += "</div>";
				
				// Meter test
				//rowHTML += "<meter value='30' max='100' class='vertical-meter'>Low</meter>";
				
				// Horizontal bar TEST
				rowHTML += "<div class='weather-bar blue stripes'><span style='width: " + tempHigh + "%'></span></div>";
				
				rowHTML += "<span class='forecast-hi'>" + tempHigh + "&#0176;</span>" + " / ";
				rowHTML += tempLow + "&#0176;<br>";
				rowHTML += "<span class='forecast-summary'>" + currentDay.summary + "</span><br>";
				rowHTML += "<table border=1 cellpadding=10 cellspacing=0>";
				rowHTML += "<tr><td>";
				rowHTML += "<i class='icon diw-" + weatherUtils.getPrecipWeatherIcon(currentDay.precipType, currentDay.precipProbability);
				rowHTML += "' style='font-size:25pt;' title='" + currentDay.precipType + "'></i>";
				rowHTML += "</td><td>";
				rowHTML += Math.round(currentDay.precipProbability) + "%";
				rowHTML += "</td></tr></table>";
				rowHTML += "</td>";
			}
			return rowHTML;
		}
		
		// Load up static helper files
		var apiKeyHelper = new ApiKeyHelper("DARKSKY");
		if (apiKeyHelper.error != "") {
			displayObj.innerHTML = apiKeyHelper.error;			
		}
		loadJSON(setWeatherDataCallback);
		
		saveWeatherInfoStatic();
		//saveWeatherInfoAJAX();
		
		var pageHTML = "<table class='' border=0 cellpadding=0 cellspacing=0><tr>";
		pageHTML += "<td style='vertical-align:top;' colspan=2>";
		pageHTML += displayWeatherInfo();
		pageHTML += "</td>";
		pageHTML += "<tr><td class='lastUpdated'>"
					+ "<div>"
					+ "<span class='api-link'>[ <a href='https://darksky.net/poweredby/'>Powered by Dark Sky</a> ]</span>"
					+ "<span style='font-size: 10px;'>" + dateNow + "</span>" 
					+ "</div>"
					+ " &nbsp;" + timeNow;
		pageHTML += "</td></tr>";
		pageHTML += "</table>";
		displayObj.innerHTML = pageHTML;
	});
</script>
</body>
</html>