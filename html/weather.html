<!DOCTYPE html>
<html>
<head>
    <title>DC Metro Bus Stop Data</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="api/wmata/bus.js"></script>
	<link href="css/style.css" rel="stylesheet">
	<link href="css/fontawesome-all.css" rel="stylesheet">
</head>
<body>
<p id="display"></p>
<script type="text/javascript">
    $(function() {
		//DARK SKY API: 1000 requests per day, 41 per hour.
		// Every 15 minutes: 96 requests/day
		// Every 5 minutes: 288 requests/day
		// 	https://api.darksky.net/forecast/d04e09fcbfb2aaece8b8eb7b9c958d91/37.8267,-122.4233
		// 	https://api.darksky.net/forecast/d04e09fcbfb2aaece8b8eb7b9c958d91/38.9281,-77.0342?exclude=minutely
		
		var api_key = "d04e09fcbfb2aaece8b8eb7b9c958d91";
		var coordinates = "38.9281,-77.0342";
		var darkSkyUrl_forecast = "https://api.darksky.net/forecast/";
		//var userStationFile = "wmata/_display_train_stations.txt";
		var refreshRate = 0;	// TODO
		
		var staticStationData = {};
		
		var dateObj = new Date();
		var dateNow = dateObj.toLocaleDateString();
		var timeNow = dateObj.toLocaleTimeString();
		var dayOfWeek = dateObj.getDay();
		var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
		var today = days[dayOfWeek];
		
		// File loading functions
		// ----------------------------------------------------------
		function loadJSON(callback) {
			var xobj = new XMLHttpRequest();
				xobj.overrideMimeType("application/json");
			// Synchronous ajax call (false)
			xobj.open('GET', 'darksky/static_dcexample.json', false);
			xobj.onreadystatechange = function () {
				  if (xobj.readyState == 4 && xobj.status == "200") {
					callback(xobj.responseText);
				  }
			};
			xobj.send(null);  			
		}	
		function setStationDataCallback(data) {
			staticStationData = JSON.parse(data);
		}	
	
		function saveStopInfo(stopID){
			var currentStopData = staticStopData.Stops.filter(function( obj ) {
			  return obj.StopID == stopID;
			})[0];			
												
			if (allStopData.length == 0 || !(stopID in allStopData)) {
				allStopData[stopID] = new BusStop(currentStopData.StopID, currentStopData.Name, currentStopData.Lat, currentStopData.Lon, currentStopData.Routes);
			}
			var busStop = allStopData[stopID];
			
			var params = {
				"api_key": api_key,
				"StopID": stopID,
			};
			$.ajax({
				url: "https://api.wmata.com/NextBusService.svc/json/jPredictions?" + $.param(params),
				type: "GET",
				async: false,
			})
			.done(function(data) {
				for (var bus = 0; bus < data.Predictions.length; bus++) {
					var currBus = data.Predictions[bus];
					busStop.addBus(currBus.VehicleID, currBus.TripID, currBus.RouteID, currBus.Minutes, currBus.DirectionNum, currBus.DirectionText);
				}	
			})
			.fail(function(xhr, status, error) {
				var err = eval("(" + xhr.responseText + ")");
				displayObj.innerHTML += "<br>Error: " + err.Message;
			});
		}    
		
		loadJSON(setStationDataCallback);
	});
</script>
</body>
</html>