<!DOCTYPE html>
<html>
<head>
    <title>DC Weather Data</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="api/darksky/weather.js"></script>
    <script src="js/api_key.js"></script>
	<link href="css/style.css" rel="stylesheet">
	<link href="css/fontawesome-all.css" rel="stylesheet">
    <!--<link href="css/dripicons-style.css" rel="stylesheet" > -->
    <link href="css/dripicons-webfont.css" rel="stylesheet">
</head>
<body>
<p id="display"></p>
<script type="text/javascript">
    $(function() {
		// Set DARKSKY API key in: 	/html/api/api_keys.txt
		//	DARK SKY API: 1000 requests per day, 41 per hour.
		// 		Every 15 minutes: 96 requests/day
		// 		Every 5 minutes: 288 requests/day
		
		var coordinates = "38.9281,-77.0342";
		var darkSkyUrl_forecast = "https://api.darksky.net/forecast/";
		//var userStationFile = "wmata/_display_train_stations.txt";
		var refreshRate = 0;	// TODO
		
		var staticWeatherData = {};		
		var allWeatherAlerts = [];
		var allWeatherHourly = {};
		var allWeatherDaily = {};
		
		var displayObj = document.getElementById("display");
		
		
		var dateObj = new Date();
		var dateNow = dateObj.toLocaleDateString();
		var timeNow = dateObj.toLocaleTimeString();
		var dayOfWeek = dateObj.getDay();
		var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
		var today = days[dayOfWeek];
		var timezone = "";
		var offset = "";
		
		// File loading functions
		// ----------------------------------------------------------
		function loadJSON(callback) {
			var xobj = new XMLHttpRequest();
				xobj.overrideMimeType("application/json");
			// Synchronous ajax call (false)
			xobj.open('GET', 'api/darksky/static_dcexample.json', false);
			xobj.onreadystatechange = function () {
				  if (xobj.readyState == 4 && xobj.status == "200") {
					callback(xobj.responseText);
				  }
			};
			xobj.send(null);  			
		}		
		function setWeatherDataCallback(data) {
			staticWeatherData = JSON.parse(data);
		}	
	
		function saveWeatherInfoStatic(){
			var weatherHourly = staticWeatherData.hourly;
			var weatherDaily = staticWeatherData.daily;
			var weatherAlerts = staticWeatherData.alerts;
			
			allWeatherHourly = new WeatherHourlies(weatherHourly);
			allWeatherDaily = new WeatherDailies(weatherDaily);

			for (var i = 0; i < weatherAlerts.length; i++) {
				allWeatherAlerts.push(new WeatherAlert(weatherAlerts[i]));
			}
		}    
		function saveWeatherInfoAJAX(stopID){
			var params = {
				"exclude": "minutely",
			};
			$.ajax({
				url: "https://api.darksky.net/forecast/" + apiKeyHelper.apiKey + "/" + coordinates + "?" + $.param(params),
				type: "GET",
				async: false,
			})
			.done(function(data) {
				var weatherData = data;
				var weatherHourly = weatherData.hourly;
				var weatherDaily = weatherData.daily;
				var weatherAlerts = weatherData.alerts;
				
				allWeatherHourly = new WeatherHourlies(weatherHourly);
				allWeatherDaily = new WeatherDailies(weatherDaily);

				if (weatherAlerts !== undefined) {
					for (var i = 0; i < weatherAlerts.length; i++) {
						allWeatherAlerts.push(new WeatherAlert(weatherAlerts[i]));
					}
				}
			})
			.fail(function(xhr, status, error) {
				var err = eval("(" + xhr.responseText + ")");
				displayObj.innerHTML += "<br>Error: " + err.Message;
			});
			
		}  
		function displayWeatherInfo() {
			var weatherUtils = new WeatherUtils();
			var pageHTML = "<table class='outerTable'>";
			
			// Alerts
			if (allWeatherAlerts.length > 0) {
				pageHTML += "<tr><td colspan='4' width='100%'>";
				pageHTML += "<table border=0 cellpadding=5 cellspacing=0>";
				if (allWeatherAlerts !== undefined || allWeatherAlerts.length > 0) {
					for (var a = 0; a < allWeatherAlerts.length; a++) {
						var currentAlert = allWeatherAlerts[a];
						pageHTML += "<tr><td>";
						pageHTML += currentAlert.title + " (" + currentAlert.regions.join(",") + ")<br>";
						pageHTML += "Severity: " + currentAlert.severity + "<br>"
						pageHTML += "Issued: " + currentAlert.getDate(currentAlert.time) + " " + currentAlert.getTime(currentAlert.time) + "<br>";
						pageHTML += "Expires: " + currentAlert.getDate(currentAlert.expires) + " " + currentAlert.getTime(currentAlert.expires) + "<br>"
						pageHTML += "<br>" + currentAlert.description + "<br>";
						pageHTML += "<a href='" + currentAlert.moreInfoUri + "'>MORE INFO</a>";
						pageHTML += "</td></tr>";
					}
				}
				pageHTML += "</table></td></tr>";
			}
			
			// Today
			// -------------------------------------------------------------
			pageHTML += "<tr><td style='vertical-align:top;' rowspan='2'>";
			var currentHour = allWeatherHourly.allHours[0];
			pageHTML += currentHour.getDay() + " ";
			pageHTML += currentHour.getDate() + " ";
			pageHTML += currentHour.getTime() + "<br>";
			pageHTML += "<i class='icon diw-" + weatherUtils.getWeatherIcon(currentHour.icon);
			pageHTML += "' style='font-size:55pt;' title='" + currentHour.icon + "'></i><br>";
			pageHTML += "<span class='forecast-hi'>" + Math.round(currentHour.temperature) + "&#0176;</span>";
			pageHTML += "&nbsp;";
			pageHTML += currentHour.summary + "<br>";
			// EVERY THREE HOURS
			pageHTML += "<table border=1 cellpadding=10 cellspacing=0>";
			for (var h = 2; h < 9; h += 3) {	
				var currentForecast = allWeatherHourly.allHours[h];
				pageHTML += "<tr>";
				pageHTML += "<td>" + currentForecast.getTime() + "</td>";
				pageHTML += "<td><i class='icon diw-" + weatherUtils.getWeatherIcon(currentForecast.icon);
				pageHTML += "' style='font-size:25pt;' title='" + currentForecast.icon + "'></i></td></tr>";
			}
			pageHTML += "</table>";
			
			var todayForecast = allWeatherDaily.allDays[0];
			pageHTML += "<span class='forecast-hi'>" + Math.round(todayForecast.temperatureHigh) + "&#0176;</span>" + " / ";
			pageHTML += Math.round(todayForecast.temperatureLow) + "&#0176;<br>";
			
			pageHTML += "<table border=1 cellpadding=10 cellspacing=0>";
			pageHTML += "<tr><td>";
			pageHTML += "<i class='icon diw-" + weatherUtils.getPrecipWeatherIcon(todayForecast.precipType, todayForecast.precipType);
			pageHTML += "' style='font-size:25pt;' title='" + todayForecast.precipType + "'></i>";
			pageHTML += "</td><td>";
			pageHTML += Math.round(todayForecast.precipProbability) + "%";
			pageHTML += "</td></tr><tr>";			
			pageHTML += "<td><i class='icon diw-sun-low' title='sunrise'></i></td><td>";
			pageHTML += weatherUtils.getTime(todayForecast.sunriseTime) + "</td><tr>";
			pageHTML += "<td><i class='icon diw-sun-lower' title='sunset'></i></td><td>";
			pageHTML += weatherUtils.getTime(todayForecast.sunsetTime) + "</td></tr></table>";
			pageHTML += "</td>";
			// -------------------------------------------------------------
			
			// Next six days
			// -------------------------------------------------------------
			for (var day = 1; day < 4; day++) {
				pageHTML += "<td>";
				var currentDay = allWeatherDaily.allDays[day];
				pageHTML += currentDay.getDay() + " ";
				pageHTML += currentDay.getDate() + "<br>";
				pageHTML += "<i class='icon diw-" + weatherUtils.getWeatherIcon(currentDay.icon);
				pageHTML += "' style='font-size:55pt;' title='" + currentDay.icon + "'></i><br>";
				pageHTML += "<span class='forecast-hi'>" + Math.round(currentDay.temperatureHigh) + "&#0176;</span>" + " / ";
				pageHTML += Math.round(currentDay.temperatureLow) + "&#0176;<br>";
				pageHTML += currentDay.summary + "<br>";
				pageHTML += "<table border=1 cellpadding=10 cellspacing=0>";
				pageHTML += "<tr><td>";
				pageHTML += "<i class='icon diw-" + weatherUtils.getPrecipWeatherIcon(currentDay.precipType, currentDay.precipProbability);
				pageHTML += "' style='font-size:25pt;' title='" + currentDay.precipType + "'></i>";
				pageHTML += "</td><td>";
				pageHTML += Math.round(currentDay.precipProbability) + "%";
				pageHTML += "</td></tr></table>";
				pageHTML += "</td>";
			}
			pageHTML += "</tr><tr>";
			for (var day = 4; day < 7; day++) {				
				pageHTML += "<td>";
				var currentDay = allWeatherDaily.allDays[day];
				pageHTML += currentDay.getDay() + " ";
				pageHTML += currentDay.getDate() + "<br>";
				pageHTML += "<i class='icon diw-" + weatherUtils.getWeatherIcon(currentDay.icon);
				pageHTML += "' style='font-size:55pt;' title='" + currentDay.icon + "'></i><br>";
				pageHTML += "<span class='forecast-hi'>" + Math.round(currentDay.temperatureHigh) + "&#0176;</span>" + " / ";
				pageHTML += Math.round(currentDay.temperatureLow) + "&#0176;<br>";
				pageHTML += currentDay.summary + "<br>";
				pageHTML += "<table border=1 cellpadding=10 cellspacing=0>";
				pageHTML += "<tr><td>";
				pageHTML += "<i class='icon diw-" + weatherUtils.getPrecipWeatherIcon(currentDay.precipType, currentDay.precipProbability);
				pageHTML += "' style='font-size:25pt;' title='" + currentDay.precipType + "'></i>";
				pageHTML += "</td><td>";
				pageHTML += Math.round(currentDay.precipProbability) + "%";
				pageHTML += "</td></tr></table>";
				pageHTML += "</td>";
			}
			pageHTML += "</tr></table>";
			// -------------------------------------------------------------
			return pageHTML;
		}
		
		// Load up static helper files
		var apiKeyHelper = new ApiKeyHelper("DARKSKY");
		loadJSON(setWeatherDataCallback);
		
		//saveWeatherInfoStatic();
		saveWeatherInfoAJAX();
		
		var pageHTML = "<table class='outerTable'><tr>";
	//	for (var s = 0; s < stopCodeOrder.length; s++) {
			pageHTML += "<td style='vertical-align:top;' colspan=2>";
			pageHTML += displayWeatherInfo();
			pageHTML += "</td>";
	//	}
		pageHTML += "<tr><td class='lastUpdated'>"
					+ "<span class='api-link'>[ <a href='https://darksky.net/poweredby/'>Powered by Dark Sky</a> ]</span>"
					+ "<span style='font-size: 10px;'>" + dateNow + "</span>" 
					+ " &nbsp;" + timeNow;
		pageHTML += "</td></tr>";
		pageHTML += "</table>";
		displayObj.innerHTML = pageHTML;
	});
</script>
</body>
</html>