<!DOCTYPE html>
<html>
<head>
    <title>Metro Data</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="wmata/train.js"></script>
	<link href="css/style.css" rel="stylesheet">
	<link href="css/fontawesome-all.css" rel="stylesheet">
</head>
<body>
<p id="demo"></p>
<script type="text/javascript">
    $(function() {
		var allLines = {
			"RD": "Red",
			"GR": "Green",
			"YL": "Yellow",
			"BL": "Blue",
			"OR": "Orange",
			"SV": "Silver"
		};	
		var allStations = {
			"E04": "Columbia Heights",
			"B01": "Gallery Pl-Chinatown",
			"F01": "Gallery Pl-Chinatown",
			"C03": "Farragut West",
			"A02": "Farragut North",
			//"A01": "Metro Center"
			//"C01": "Metro Center"
		};
		// TODO grab codes from names
		var stationOrder = [ "Columbia Heights", "Farragut North", "Farragut West", "Gallery Pl-Chinatown" ];
			
		var displayObj = document.getElementById("demo");
		var allStationData = {};
		var stationData = {};
		
		var dateObj = new Date();
		var dateNow = dateObj.toLocaleDateString();
		var timeNow = dateObj.toLocaleTimeString();
		var dayOfWeek = dateObj.getDay();
		var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
		var today = days[dayOfWeek];
		
		function setStationData(data) {
			stationData = JSON.parse(data);
		}

		function createRow(currRows, line, cars, min, dest) {
			currRows += "<tr>";
			currRows += "<td class='" + line + "'>" + line + "</td>";
			currRows += "<td>" + cars + "</td>";
			currRows +=	"<td>" + dest + "</td>";
			currRows += "<td style='text-align:right;'";
			if (min == "BRD") { currRows += " class='blink_me'" }
			currRows += ">" + min;
			if (min != "BRD" && min != "ARR") {
				currRows += " min";
			}
			currRows += "</td>"
			currRows += "</tr>";
			return currRows;
		}
		
		function createLastTrainRow(currRows, line, time, dest) {
			var lastTime = new Date(dateNow + " " + time);
			var oneMinute = 1000*60;
			var timeMath = Math.ceil((lastTime - dateObj) / oneMinute);
			if (timeMath <= 160) {
				currRows += "<tr>";
				currRows += "<td class='" + line + "'>" + line + "</td>";
				currRows += "<td colspan='2' class='lastTrain'>Last train to <b>" + dest + "</b>:</td>";
				currRows += "<td style='text-align:right;'><b>" + lastTime.toLocaleTimeString() + "</b><br>(" + timeMath + " mins)</td>";
				currRows += "</tr>";
				return currRows;
			}
		}
      
		function loadJSON(callback) {
			var xobj = new XMLHttpRequest();
				xobj.overrideMimeType("application/json");
			xobj.open('GET', 'wmata/stationcodes.json', false);
			xobj.onreadystatechange = function () {
				  if (xobj.readyState == 4 && xobj.status == "200") {
					// Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
					callback(xobj.responseText);
				  }
			};
			xobj.send(null);  			
		}
	  
		function stationInfo(stationList){
			var params = {
				"api_key": "{api_key}",
				//"StationCodes": "All"
				"StationCodes": stationList,
				//"LineCode:" "RD",
				// Request parameters
				//"LineCode": lineColor,
			};
					
			$.ajax({
				url: "https://api.wmata.com/StationPrediction.svc/json/GetPrediction/" + stationList + "?" + $.param(params),				
				//url: "https://api.wmata.com/Rail.svc/json/jStations?" + $.param(params),
				type: "GET",
			})
			.done(function(data) {
				var locationNames = [];
				// TODO: ordering stations
				for (var train = 0, len = data.Trains.length; train < len; train++) {
					var currTrain = data.Trains[train];
					if (locationNames.indexOf(currTrain.LocationName) < 0) {
						locationNames.push(currTrain.LocationName);
					}										
					if (allStationData.length == 0 || !(currTrain.LocationName in allStationData)) {
						allStationData[currTrain.LocationName] = new MetroStation(currTrain.LocationName);
					}
					// Stations can have multiple codes, get trainStation by name
					var trainStation = allStationData[currTrain.LocationName];
					trainStation.addLocationCode(currTrain.LocationCode);
					trainStation.addTrain(currTrain.Line, currTrain.Car, currTrain.Min, currTrain.DestinationCode, currTrain.DestinationName, currTrain.Group);
				}	
					
				// Add end trains
				for (var k = 0; k < locationNames.length; k++) {
					var currentStation = allStationData[locationNames[k]];
					var allLocationCodes = currentStation.getLocationCodes().split(", ");
					for (var j = 0; j < allLocationCodes.length; j++) {
						var currentStationData = stationData.Stations.filter(function( obj ) {
						  return obj.Code == allLocationCodes[j];
						})[0];
						var openingTime = currentStationData[today].OpeningTime;
						for (var i = 0; i < currentStationData[today].FirstTrains.length; i++) {
							var trainObj = currentStationData[today].FirstTrains[i];
							currentStation.addEndTrain("First", trainObj.Time, trainObj.DestinationStation, trainObj.DestinationStationName
		, trainObj.DestinationStationLines);
						}
						for (var i = 0; i < currentStationData[today].LastTrains.length; i++) {
							var trainObj = currentStationData[today].LastTrains[i];
							currentStation.addEndTrain("Last", trainObj.Time, trainObj.DestinationStation, trainObj.DestinationStationName
		, trainObj.DestinationStationLines);
						}
					}
				}
				
				var pageTable = "<table class='outerTable'><tr>";
				for (var st = 0; st < stationOrder.length; st++) {				
					var station = allStationData[stationOrder[st]];
					var tableData = "<td style='vertical-align:top;'><table>" + 
					"<tr><th colspan=4 class='stationHeader'><b>STATION [" + station.getLocationCodes() + "]: " +  station.locationName + 
						"</b></th></tr>";
					
					var northTrains = "";
					var southTrains = "";
					var eastTrains = "";
					var westTrains = "";
					
					var northList = station.getTrains("north");
					var southList = station.getTrains("south");
					var eastList = station.getTrains("east");
					var westList = station.getTrains("west");
					
					for (var i = 0, len = northList.length; i < len; i++) {
						currTrain = northList[i];  
						northTrains = createRow(northTrains, currTrain.Line, currTrain.Cars, currTrain.Min, currTrain.DestinationName);
					}
					var lastTrain = station.lastTrains["north"];
					if (typeof lastTrain != "undefined") {
						northTrains = createLastTrainRow(northTrains, lastTrain.DestinationLines, lastTrain.Time, lastTrain.DestinationName);
					}
					for (var i = 0, len = southList.length; i < len; i++) {
						currTrain = southList[i];
						southTrains = createRow(southTrains, currTrain.Line, currTrain.Cars, currTrain.Min, currTrain.DestinationName);						
					}		
					var lastTrain = station.lastTrains["south"];
					if (typeof lastTrain != "undefined") {
						southTrains = createLastTrainRow(southTrains, lastTrain.DestinationLines, lastTrain.Time, lastTrain.DestinationName);
					}			
					for (var i = 0, len = eastList.length; i < len; i++) {
						currTrain = eastList[i];
						eastTrains = createRow(eastTrains, currTrain.Line, currTrain.Cars, currTrain.Min, currTrain.DestinationName);						
					}
					var lastTrain = station.lastTrains["east"];
					if (typeof lastTrain != "undefined") {
						eastTrains = createLastTrainRow(eastTrains, lastTrain.DestinationLines, lastTrain.Time, lastTrain.DestinationName);
					}
					for (var i = 0, len = westList.length; i < len; i++) {
						currTrain = westList[i];
						westTrains = createRow(westTrains, currTrain.Line, currTrain.Cars, currTrain.Min, currTrain.DestinationName);						
					}
					var lastTrain = station.lastTrains["west"];
					if (typeof lastTrain != "undefined") {
						westTrains = createLastTrainRow(westTrains, lastTrain.DestinationLines, lastTrain.Time, lastTrain.DestinationName);
					}
							
					var trainProperties = new TrainProperties();
					if (southTrains != "")
					{
						tableData += "<tr><td class='destinationHeader' style='text-align:center;'><b><i class='" +
						trainProperties.getDirectionIcon("south") + "'></i>" + "<td class='destinationHeader' colspan='3'>" + station.getDestinations("south") + "</td></tr>";
						tableData += southTrains;
					}
						
					if (northTrains != "")
					{		   
						tableData += "<tr><td class='destinationHeader' style='text-align:center;'><b><i class='" +
						trainProperties.getDirectionIcon("north") + "'></i>" + "<td class='destinationHeader' colspan='3'>" + station.getDestinations("north") + "</td></tr>";
						tableData += northTrains;
					}
					
					if (eastTrains != "")
					{		  
						tableData += "<tr><td class='destinationHeader' style='text-align:center;'><b><i class='" +
						trainProperties.getDirectionIcon("east") + "'></i>" + "<td class='destinationHeader' colspan='3'>" + station.getDestinations("east") + "</td></tr>";
						tableData += eastTrains;
					}
					if (westTrains != "")
					{		  
						tableData += "<tr><td class='destinationHeader' style='text-align:center;'><b><i class='" +
						trainProperties.getDirectionIcon("west") + "'></i>" + "<td class='destinationHeader' colspan='3'>" + station.getDestinations("west") + "</td></tr>";
						tableData += westTrains;
					}				
					tableData += "</table></td>";	
					pageTable += tableData;
				}
			    pageTable += "</tr></table>";
				displayObj.innerHTML = pageTable;
			})
			.fail(function(xhr, status, error) {
				var err = eval("(" + xhr.responseText + ")");
				displayObj.innerHTML = "error: " + err.Message;
			});
		}		
		var stationList = Object.keys(allStations).map(function(x){return x;}).join(',');
		loadJSON(setStationData);
		stationInfo(stationList);
    });
</script>
</body>
</html>